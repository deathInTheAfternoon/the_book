<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Rust HTTP server - The Book</title>


        <!-- Custom HTML head -->
        
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->

    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="../rust_enums.html"><strong aria-hidden="true">1.</strong> Rust Enums</a></li><li class="chapter-item expanded "><a href="../front_proxy.html"><strong aria-hidden="true">2.</strong> Example: front proxy load balancer</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../example_front_proxy/simple_http_server.html" class="active"><strong aria-hidden="true">2.1.</strong> Rust HTTP server</a></li><li class="chapter-item expanded "><a href="../example_front_proxy/dockerize_server.html"><strong aria-hidden="true">2.2.</strong> Dockerize the server</a></li><li class="chapter-item expanded "><a href="../example_front_proxy/obeservations.html"><strong aria-hidden="true">2.3.</strong> Observational notes</a></li></ol></li><li class="chapter-item expanded "><a href="../labs/namespaces/lab_namespaces.html"><strong aria-hidden="true">3.</strong> Labs: Namespaces</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../labs/namespaces/host_host.html"><strong aria-hidden="true">3.1.</strong> First smart cable (host to host)</a></li><li class="chapter-item expanded "><a href="../labs/namespaces/host_red.html"><strong aria-hidden="true">3.2.</strong> Smart cable from computer to host</a></li><li class="chapter-item expanded "><a href="../labs/namespaces/red_blue.html"><strong aria-hidden="true">3.3.</strong> 2 computers (point-point)</a></li><li class="chapter-item expanded "><a href="../labs/namespaces/red_br_blue.html"><strong aria-hidden="true">3.4.</strong> Two computers (bridged)</a></li><li class="chapter-item expanded "><a href="../labs/namespaces/red_green_blue.html"><strong aria-hidden="true">3.5.</strong> 3 computers (point-point)</a></li><li class="chapter-item expanded "><a href="../labs/namespaces/internet_access.html"><strong aria-hidden="true">3.6.</strong> Finale: internet access</a></li></ol></li><li class="chapter-item expanded "><a href="../networking.html"><strong aria-hidden="true">4.</strong> Networking (L2 + L3)</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">The Book</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="rust-http-serve"><a class="header" href="#rust-http-serve">Rust HTTP serve</a></h1>
<p>We wish to build a simple HTTP server in Rust using the Rocket library. For demo simplicity, this system only runs on a single PC or laptop (the host).</p>
<p>When started, an instance of the server will generate a UUID. This is returned when the index page is requested.
Later, we will use this UUID to check round-robin load balancing is working correctly.</p>
<p>We will also need to bind an instance of the server to an IP address and port number. This option is useful when running inside a Docker container.
'Binding to an IP address and port number' means an application starts listening for incoming messages on its chosen IP and port. For example, the default bind address of the Rocket framework is 127.0.0.1:8080. This is generally fine if running directly on the host as multiple processes can communicate with each other without leaving the machine and relying only on the port number to distinguish themselves from each other.</p>
<h2 id="sidebar-linux-networking-namespaces"><a class="header" href="#sidebar-linux-networking-namespaces">Sidebar: Linux networking namespaces</a></h2>
<h3 id="veth-virtual-ethernet"><a class="header" href="#veth-virtual-ethernet">VETH (Virtual Ethernet)</a></h3>
<p>A VETH is a <strong>local</strong> Ethernet tunnel between two endpoints called 'devices'. Imagine attaching a NIC to a server. In Linux, a network namespace resembles an isolated sever and the VETH device is the ethernet card that will be used by that server to talk to other network namespaces (servers). It is even the case that, as with a newly installed physical card, a VETH device must be assigned an IP address so other isolated namespaces (servers) can find it.</p>
<p>However, installing a NIC and giving it an IP is not enough to form a network. In the physical world we build a LAN by connecting a CAT-5 cable from our NIC to a switch. If we connect a second server to that switch then we have a physical network allowing traffic to flow from one machine to another. Likewise, within a single host a Linux 'bridge' acts as a switch. The Linux kernel can create software switches on demand. </p>
<p>In the software world, VETH can only create a <em>pair</em> of connected devices. Imagine if you could only buy two NICs with a cable between them. If that were the case, then you would need to install one device on a server and the other device on a different server or a physical switch to build a network. This is how VETH devices are created. So when you create your pair of devices you must associate each end with its target namespace or software switch.</p>
<h3 id="demo-to-show-how-to-create-veth-devices-ns-and-bridge"><a class="header" href="#demo-to-show-how-to-create-veth-devices-ns-and-bridge">Demo to show how to create VETH devices, NS and bridge.</a></h3>
<pre><code class="language-console">## Create 2 namespaces, bridge and 2 VETH devices.
# Only loopback interface is created by default within namespace
ip netns add red
ip netns add blue

# Create software switch and turn it on
ip link add name br1 type bridge
ip link set br1 up

# Create a VETH pair. We name each end to show which will plugin to the server 
# and which will plugin to the switch
ip link add server-plug1 type veth peer name bridge-plug1
ip link add server-plug2 type veth peer name bridge-plug2

## Wire up the network (connect each server to the switch)
# Connect one end of the VETH pair into the server
ip link set server-plug1 netns red
ip link set server-plug2 netns blue

# Plug the other end into switch
ip link set bridge-plug1 master br1
ip link set bridge-plug2 master br1

# Assign IP to server connector. Different IPs as they will connect to the same software switch
ip netns exec red ip addr add 192.168.1.11/24 dev server-plug1
ip netns exec blue ip addr add 192.168.1.12/24 dev server-plug2

Assign IP address and broadcast address to bridge. Host traffic with destination
# range 192.168.1.10/24 will now go to this bridge. Futher, 192.168.1.10 is the IP of this bridge accessible form any namespace as well as host machine.
ip addr add 192.168.1.10/24 brd + dev br1

# Power up each connector
ip link set bridge-plug1 up
ip link set bridge-plug2 up

ip netns exec red ip link set server-plug1 up
ip netns exec blue ip link set server-plug2 up

</code></pre>
<p>TODO: This is not finished (need Gateway and NAT) see https://ops.tips/blog/using-network-namespaces-and-bridge-to-isolate-servers/</p>
<h3 id="demo-to-show-docker-commands-to-investigate-bridges"><a class="header" href="#demo-to-show-docker-commands-to-investigate-bridges">Demo to show Docker commands to investigate bridges.</a></h3>
<h2 id="story-continued"><a class="header" href="#story-continued">Story continued</a></h2>
<p>As we've mentioned when running within network namespace, each VETH device end will have an assigned IP address that can be used by the virtual switch to communicate with whoever is listening on that endpoint. Now if a daemon is not listening on that endpoint then a browser on the host will get no response form the HTTP daemon. This is what happens if you configure the HTTP daemon to listen on 127.0.0.1 because the bridge is sending external traffic to the other IP.</p>
<p>However, if the daemon listens to 0.0.0.0 it will effectively be listening on all IP addresses the container exposes. So when we start our process within a container, we will bind it to such an address.</p>
<h1 id="code-for-rust-http-daemon"><a class="header" href="#code-for-rust-http-daemon">Code for Rust HTTP daemon</a></h1>
<p>This project was created using Cargo workspaces. TODO: Cover that somewhere else.</p>
<p>We use these dependencies:</p>
<pre><code class="language-yaml">[dependencies]
lib_container_runtime = {path = &quot;../lib_container_runtime&quot;}
rocket = &quot;0.5.0-rc.1&quot;
uuid = { version = &quot;0.8&quot;, features = [&quot;serde&quot;, &quot;v4&quot;] }
clap = {version = &quot;3.0.14&quot;, features = [&quot;derive&quot;]}
</code></pre>
<ul>
<li>The lib_container_runtime was my custom Rust library that can be used by this package.</li>
<li>rocket is a lightweight Rust HTTP server framework.</li>
<li>uuid is a library for creating the UUID we will use to label each instance.</li>
<li>clap is a command line argument parser we use to specify the bind address and port number.</li>
</ul>
<p>The main application is here:</p>
<pre><pre class="playground"><code class="language-rust">#[macro_use] extern crate rocket;
use uuid::Uuid;
use clap::Parser;
use rocket::State;

#[derive(Parser, Debug)]
#[clap(name(&quot;Rocket daemon&quot;), author(&quot;DeathInTheAfternoon&quot;), version(&quot;0.1&quot;), about(&quot;Does what is says on the tin.&quot;), long_about=None)]
struct Args {
    /// Set the listening port
    /// 
    /// This parameter will configure the port on which this daemon listens for incoming requests.
    #[clap(short('p'), long(&quot;port&quot;), default_value_t = 8080)]
    port: i32,

    /// Set host IP to which we bind
    /// 
    /// When in Docker container bind to ALL interfaces 0.0.0.0 NOT 127.0.0.1.
    #[clap(short('a'), long(&quot;address&quot;), default_value = &quot;127.0.0.1&quot;)]
    address: String,
}

// Structure used to store state shared between handlers...
struct DaemonState {
    uuid: Uuid,
}

#[get(&quot;/&quot;)]
fn index(hit_count: &amp;State&lt;DaemonState&gt;) -&gt; String {
    format!(&quot;My id is {}&quot;, hit_count.uuid)
}

#[get(&quot;/users&quot;)]
fn get_users() -&gt; &amp;'static str {
    &quot;You're my first user&quot;
}

#[rocket::main]
async fn main() {
    let args = Args::parse(); 
    // Start Rocket using a custom ip address and port number
    let figment = rocket::Config::figment().merge((&quot;port&quot;, args.port))
                                                    .merge((&quot;address&quot;, args.address));
    rocket::custom(figment)
            .mount(&quot;/&quot;, routes![index, get_users])
            .manage(DaemonState { uuid: Uuid::new_v4(), })
            .launch().await;
}
</code></pre></pre>
<p>The 'struct Args' is used by Clap to define command line arguments. It also uses the Rust Doc '///' comments to generate help messages.</p>
<p>The 'DaemonState' structure holds shared state. In this case it's the UUID created when the daemon starts. Shared state is difficult to achieve in Rust as it wants to be thread safe whereas global variables make that difficult to achieve (TODO: Section on concurrency and what it expects). So instead we use the shared state system built into Rocket. In fact, you can see how the Rocket framework is passing the shared state into the 'index()' handler.</p>
<p>The main() function shows how to read arguments from the command line and use them to configure the rocket engine.</p>
<p>To build and run in the foreground (exit using Ctrl-C):</p>
<pre><code class="language-console">cargo run --release
</code></pre>
<p>And you can check the uuid of the instance using from another terminal:</p>
<pre><code class="language-console">curl 127.0.0.1:8080
    My id is edbf4f84-8770-4205-9fe1-70f40b0aaf2b
</code></pre>
<p>If you want to pass a command line parameter use '--' to instruct cargo:</p>
<pre><code class="language-console">cargo run --release -- --address 0.0.0.0 --port 8081
</code></pre>
<p>Again, from another terminal (we're starting another instance to UUID will change):</p>
<pre><code class="language-console">curl 127.0.0.1:8081
    My id is eb84b536-b75b-4bd6-99ee-3c0066ec2943
curl 0.0.0.0:8081
    My id is eb84b536-b75b-4bd6-99ee-3c0066ec2943
</code></pre>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../front_proxy.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next" href="../example_front_proxy/dockerize_server.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../front_proxy.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next" href="../example_front_proxy/dockerize_server.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script type="text/javascript">
            window.playground_copyable = true;
        </script>


        <script src="../elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../searcher.js" type="text/javascript" charset="utf-8"></script>

        <script src="../clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="../book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->


    </body>
</html>
